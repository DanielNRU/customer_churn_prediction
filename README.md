# Прогнозирование оттока клиентов

## Описание проекта

**Тестовое задание от [А ДЕНЬГИ](https://adengi.ru/) в формате соревнования на [Kaggle](https://www.kaggle.com/competitions/adengi-internship/leaderboard)**

### Работу выполнил
[Мельник Даниил](https://github.com/DanielNRU/)

---

## Цель

Разработать модель машинного обучения для прогнозирования оттока клиентов. Модель должна максимально точно предсказывать, уйдет ли клиент (отток) или останется (не отток) в течение 20 дней после открытия займа.

## Задачи

1. Изучить предоставленный набор данных и подготовить его для обучения модели.
2. Исследовать существующие подходы к прогнозированию оттока и выбрать оптимальную модель.
3. Обучить и протестировать модель, используя несколько методов (XGBoost, CatBoost, LightGBM и др.).
4. Провести анализ результатов и предложить пути улучшения модели.

## Формат проекта

Индивидуальное соревнование на платформе [Kaggle](https://www.kaggle.com/competitions/adengi-internship/leaderboard).  
**Основная метрика оценки** — **F1‑Score**, отражающая баланс между точностью и полнотой предсказаний.

---

## Данные

### Описание набора данных

Заказчик предоставляет данные о клиентах и их займах, включающие:
- **train.csv** — датасет для обучения модели.
- **test.csv** — датасет для валидации модели.
- **sample_submission.csv** — пример файла для отправки решений.

### Описание признаков

- `monthly_income`: Среднемесячный заработок клиента.  
- `payment_frequency`: Частота получения зарплаты (например, раз в месяц или раз в две недели).  
- `status`: Статус клиента (самозанятый, рабочий и т.д.).  
- `work_experience`: Количество лет стажа клиента.  
- `client_type`: Тип клиента (новый, повторный).  
- `settlement`: Город клиента.  
- `requested_sum`: Запрашиваемая сумма клиента для займа.  
- `region`: Регион клиента (область, округ и т.д.).  
- `loan_id`: Уникальный идентификатор займа.  
- `client_id`: Уникальный идентификатор клиента.  
- `main_agreement_amount`: Основная одобренная сумма по займу.  
- `main_agreement_term`: Основной одобренный срок по займу.  
- `requested_period_days`: Запрашиваемый срок по займу.  
- `requested_amount`: Запрашиваемая сумма по займу.  
- `req_app_amount`: Разница между запрашиваемой и одобренной суммой.  
- `approved_amount`: Одобренная сумма по займу.  
- `source`: Канал привлечения клиента.  
- `first_source`: Первый канал привлечения клиента.  
- `period_days`: Период страховки по займу.  
- `interface`: Интерфейс, откуда пришла заявка (сайт, мобильное приложение).  
- `created_at`: Дата открытия займа.  
- `type`: Тип займа (тип продукта).  
- `closed_at`: Дата закрытия займа.  
- `days_finish_loan`: Время в днях, затраченное на закрытие займа.  
- `gender`: Пол клиента.  
- `ag`: Возраст клиента.  
- `repayment_type`: Тип комиссии по займу.  
- `loan_order`: Порядковый номер займа.  
- `have_extension`: Наличие пролонгации по займу.  
- `cnt_ext`: Количество пролонгаций по займу.  
- `start_dt`: Дата начала пролонгаций.  
- `term`: Срок пролонгации.  
- `price`: Цена пролонгации.  
- `elecs_sum`: Штрафы и пени.  
- `recurents_sum`: Штрафы и пени (различия в этапах начисления).  
- `tamount`: Общий кэшфлоу клиента.  
- `issues`: Сумма просрочек, штрафов и пени.  
- `principal`: Сумма основного долга.  
- `interest`: Прибыль с клиента.  
- `overdue_interest`: Прибыль с клиента, если есть просрочка.  
- `overdue_fee`: Штрафы за просрочку.  
- `contact_cases`: Количество обращений клиента в коллекшн.  
- `nbki_score`: Скор клиента от рисков.  

- `churn`: Целевая переменная (отток клиента или нет).

#### Формат файла submission.csv

Для каждого займа (`loan_id`) из **test.csv** необходимо предсказать отток (1) или не отток (0).  
**Пример:**

```csv
loan_id,churn
159,1
228,0
1489,1
347876,0
```

---

## Технологический стек

Python, Pandas, NumPy, Scikit-learn, XGBoost, CatBoost, LightGBM, Optuna, SHAP, PyTorch, Matplotlib, Seaborn, Phik, Tqdm

---

## Этапы проекта

### 1. Подготовка окружения

- Импорт необходимых библиотек и настройка рабочего пространства для обеспечения стабильной работы всех компонентов.

### 2. Загрузка и предобработка данных

- Данные загружались с использованием Dask.
- Для предобработки применён класс `DataPreprocessorOptimized`, который выполнял:
  - Очистку текстовых признаков (например, нормализацию `region` и `settlement`).
  - Обработку временных признаков (извлечение месяца, дня недели, расчет промежутков между займами).
  - Генерацию финансовых коэффициентов (например, `approved_requested_ratio`).
  - Заполнение пропусков медианой.
  - Кодирование категориальных признаков (one-hot и порядковое кодирование).

### 3. Создание новых признаков

- Генерация дополнительных признаков, позволяющих глубже охарактеризовать клиентов и их займы, что способствовало повышению описательной способности модели.

### 4. Разведочный анализ

- Проведена детальная визуализация распределения целевой переменной.
- Выполнена проверка гипотез с использованием t‑теста для выявления статистически значимых различий между группами клиентов.

### 5. Обучение моделей

- Данные были разделены на обучающую и тестовую выборки.
- Обучались модели CatBoost, XGBoost и LightGBM.  
- Все модели показали схожие результаты, однако наилучшие показатели достигла модель CatBoost с F1‑score 0.9236 на тестовых данных при времени предсказания 11.3 секунды.  
- **Гиперпараметры модели CatBoost, подобранные с помощью Optuna:**
  - **n_estimators:** 2500  
  - **max_depth:** 8  
  - **learning_rate:** 0.13821493790358336  
  - **l2_leaf_reg:** 3.926232424209116  
  - **border_count:** 152

### 6. Используемые признаки

В модель были включены следующие ключевые показатели:  
`approved_requested_ratio`, `contact_cases`, `created_dayofweek`, `created_month`, `first_source`, `gender`, `have_extension`, `interface`, `loan_count`, `loan_frequency`, `loan_order`, `payment_frequency`, `region`, `repayment_type`, `settlement`, `settlement_category`, `source`, `status_client_type`, `time_between_loans`, `time_between_loans_mean`, `time_since_first_loan`, `time_since_last_loan`, `type`.

### 7. Наиболее значимые признаки

**Описание наиболее важных признаков:**

- **loan_count:** Общее количество займов, оформленных клиентом, что позволяет оценить его кредитную активность и историю сотрудничества.  
- **loan_order:** Порядковый номер займа в истории клиента, определяющий последовательность обращений за кредитными продуктами.  
- **time_between_loans_mean:** Среднее время между займами, что характеризует регулярность обращений клиента за кредитом.  
- **time_since_last_loan:** Количество дней с момента последнего займа, отражающее недавнюю активность клиента в сфере кредитования.  
- **have_extension:** Индикатор наличия пролонгации по займу, свидетельствующий о продлении срока выплаты и возможных финансовых трудностях.

**Портрет клиента, склонного к оттоку:**  
Такие клиенты, как правило, являются относительно новыми с меньшим количеством займов, демонстрируют нерегулярный график заимствований (последний займ оформлен недавно, а интервалы между займами немного увеличены) и чаще прибегают к пролонгациям, что может указывать на их финансовые трудности.

---

## Docker и FastAPI с Gradio

Для развертывания веб‑приложения был создан Docker‑образ с Gradio, доступного по адресу:

`danielnru/customer_churn_prediction:latest`

### Инструкция по загрузке и запуску Docker‑контейнера

1. **Скачать Docker‑образ:**

   ```bash
   docker pull danielnru/customer_churn_prediction:latest
   ```

2. **Запустить Docker‑контейнер:**

   ```bash
   docker run --gpus all -p 8000:8000 -p 7860:7860 danielnru/customer_churn_prediction:latest
   ```

   Это запустит контейнер в фоновом режиме, и ваше приложение будет доступно по адресу `http://localhost:7860`.

3. **Проверка работы:**

   Откройте браузер и перейдите по адресу [http://localhost:7860](http://localhost:7860). Вы увидите Gradio‑интерфейс, позволяющий загрузить CSV‑файл с данными, получить предсказание модели и скачать результаты.

---

## Перспективы дальнейшего развития

Предложенный подход можно совершенствовать, добавляя новые модели, расширяя этапы предобработки и проводя более глубокий анализ признаков. Это позволит не только повысить точность прогнозирования, но и лучше понять ключевые факторы, влияющие на отток клиентов.

---